# Basic CRUD Service

Асинхронный CRUD-сервис, созданный с использованием FastAPI, SQLAlchemy 2.0 и PostgreSQL. Проект демонстрирует лучшие практики построения масштабируемых и поддерживаемых веб-приложений на Python.

## Ключевые технологии и особенности

- **FastAPI**: Для создания высокопроизводительных API с автоматической генерацией документации.
- **SQLAlchemy 2.0**: Для асинхронной работы с базой данных в современном декларативном стиле.
- **PostgreSQL**: В качестве надежной реляционной базы данных.
- **Pydantic V2**: Для строгой валидации данных и управления конфигурацией через переменные окружения.
- **Асинхронность**: Полностью асинхронный код (`async/await`) от эндпоинта до запроса в базу данных.
- **Слоистая архитектура**: Четкое разделение логики на слои (конфигурация, доступ к данным, API), что упрощает поддержку и масштабирование.
- **Управление зависимостями**: С помощью `requirements.txt` и виртуального окружения.
- **Docker**: Для легкого развертывания PostgreSQL с помощью `docker-compose`.

## Этапы создания проекта

Проект развивался итерационно, проходя через несколько ключевых этапов рефакторинга и улучшения архитектуры.

### Шаг 1: Первоначальная настройка (в одном файле)

Изначально вся логика была сосредоточена в одном файле `main.py`. Это включало:
- Создание экземпляра FastAPI.
- Определение моделей SQLAlchemy и схем Pydantic.
- Реализация всех CRUD-операций.
- Использование `aiosqlite` для простоты.

Этот подход хорош для прототипирования, но быстро становится трудноподдерживаемым.

### Шаг 2: Переход к модульной структуре

Для улучшения читаемости и поддержки проект был реорганизован в пакет `src`:
- Код был разделен на логические модули: `config.py`, `database.py`, `schemas.py`, `core/app.py`.
- Точкой входа стал `src/__main__.py`, что позволило запускать проект как модуль (`python -m src`).
- Были исправлены относительные импорты для корректной работы внутри пакета.

### Шаг 3: Внедрение слоистой архитектуры

Проект был разделен на слои для лучшего разделения ответственности:
- `src/database/`: все, что связано с базой данных (`models.py`, `session.py`, `init_db.py`).
- `src/schemas/`: схемы Pydantic для валидации входящих и исходящих данных.
- `src/api/`: эндпоинты FastAPI, сгруппированные по ресурсам (`routes/users.py`, `routes/admin.py`).
- `src/core/`: ядро приложения, включая фабрику `create_app` и управление жизненным циклом (`lifespan`).

### Шаг 4: Переход на PostgreSQL

Для использования более мощной СУБД проект был переведен с SQLite на PostgreSQL:
1.  **Добавлены зависимости**: `asyncpg` для асинхронной работы с PostgreSQL.
2.  **Обновлена конфигурация**: в `config.py` добавлена логика для формирования `database_url` из переменных окружения (`.env`).
3.  **Настроен пул соединений**: в `database/session.py` были добавлены параметры `pool_size` и `pool_pre_ping` для оптимизации работы с БД.
4.  **Добавлен Docker**: создан `docker-compose.yml` для быстрого развертывания экземпляра PostgreSQL.

## Структура проекта

```
Basic-CRUD-Service-Python/
├── .env                    # Переменные окружения (не хранится в git)
├── .env.example            # Пример файла с переменными окружения
├── .gitignore              # Файлы и папки, игнорируемые git
├── docker-compose.yml      # Конфигурация для запуска PostgreSQL в Docker
├── requirements.txt        # Зависимости Python
└── src/
    ├── __init__.py
    ├── __main__.py         # Точка входа для запуска приложения
    ├── config.py           # Конфигурация приложения (Pydantic Settings)
    ├── api/
    │   ├── dependencies.py # Общие зависимости FastAPI (например, сессия БД)
    │   └── routes/
    │       ├── admin.py    # Роутер для административных задач
    │       └── users.py    # CRUD-операции для пользователей
    ├── core/
    │   └── app.py          # Фабрика для создания FastAPI приложения и lifespan
    ├── database/
    │   ├── init_db.py      # Логика для инициализации таблиц в БД
    │   ├── models.py       # Модели SQLAlchemy (ORM)
    │   └── session.py      # Настройка engine и сессий SQLAlchemy
    └── schemas/
        └── user.py         # Схемы Pydantic для сущности "Пользователь"
```

## Установка и запуск

### 1. Клонирование репозитория
```bash
git clone <repository_url>
cd Basic-CRUD-Service-Python
```

### 2. Настройка окружения
```powershell
# Создать и активировать виртуальное окружение
python -m venv .venv
.venv\Scripts\activate

# Установить зависимости
pip install -r requirements.txt

# Создать файл .env из примера и указать пароль
copy .env.example .env
# Откройте .env и замените your_password_here на ваш пароль
```

### 3. Запуск базы данных
Убедитесь, что у вас установлен и запущен Docker.
```powershell
# Запустить PostgreSQL в контейнере Docker
docker-compose up -d
```

### 4. Запуск приложения
```powershell
# Запустить FastAPI приложение
python -m src
```
Приложение будет доступно по адресу `http://localhost:4444`.

## API

Интерактивная документация API (Swagger UI) доступна по адресу:
[http://localhost:4444/docs](http://localhost:4444/docs)

- `POST /admin/init_db` - Инициализация БД (удаляет существующие таблицы!)
- `POST /users/` - Создание пользователя
- `GET /users/` - Получение списка всех пользователей
- `GET /users/{user_id}` - Получение пользователя по ID
- `PATCH /users/{user_id}` - Частичное обновление пользователя
- `DELETE /users/{user_id}` - Удаление пользователя